# Block Identity Center User
## Overview
One of the containment steps defined by [AWS in the playbook to respond against compromised IAM Credentials](https://github.com/aws-samples/aws-customer-playbook-framework/blob/main/docs/Compromised_IAM_Credentials.md#containment) from a user from Identity Center is to revoke role sessions.

AWS proposes the following steps:

```plaintext
1. Identify the permission set(s) being used by the user.
2. From the Identity Center console, click on Permission Sets.
3. Select the name of the permission set.
4. Scroll down to ‘Inline Policy’ and click on the Edit button.
5. Add the following policy:
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Deny",
      "Action": "*",
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "identitystore:userId": "example"
        },
        "DateLessThan": {
          "aws:TokenIssueTime": "2023-09-26T15:00:00.000Z"
        }
      }
    }
  ]
}

Update ‘example’ to the user’s Identity Center User ID, found in the ‘General information’ box of the user’s User page. The value for `aws:TokenIssueTime` should equal the time when you apply this policy.
```

As this process might be time-consuming and prone to errors, the following automation will deploy a lambda that manages the creation/deletion of the inline policy in all permission sets assigned to the user and also provisions the permission sets to all accounts.

## Deployment

The provided Terraform will deploy a lambda and create a role with the following permissions:

```plaintext
"sso:ListInstances",
"sso:ListPermissionSets",
"sso:GetInlinePolicyForPermissionSet",
"sso:PutInlinePolicyToPermissionSet",
"sso:DeleteInlinePolicyFromPermissionSet",
"sso:ListAccountsForProvisionedPermissionSet",
"sso:ProvisionPermissionSet",
"sso:DescribePermissionSetProvisioningStatus",
"identitystore:ListUsers"
"iam:GetRole",
"iam:ListAttachedRolePolicies",
"iam:PutRolePolicy"
```

Before deploying, make sure to configure the `shared.auto.tfvars.json` that needs:

- `identity_store_id`: In the AWS Identity Center dashboard, search for the Settings summary and click "Go to settings". Here, in the identity source section, you'll see the Identity Store ID.
- `region`: Configure the region where the Identity Center is deployed.
- `enable_datadog_role`: When true, it will create a role with the necessary permissions to invoke the lambda from Datadog.
- `datadog_external_id`: Only necessary when the `enable_datadog_role` is set to true, this is the external ID generated by Datadog when creating the connection.

## How to Use It

Once deployed, we'll have a lambda called `BlockIdentityCenterUser`. This lambda accepts 2 inputs:

- `user_name`: The Username from the identity center that you want to block or unblock.
- `block`: true or false. When set to true, it will add the inline policy to block the user in all permission sets; when set to false, it will delete the inline policy from all the permission sets.

Example:
```json
{
  "user_name": "TestUser",
  "block": true
}
```

## How to Use It with Datadog (Optional)

1. Create a new connection, define the connection name that you want, your account ID, and as AWS Role Name `DatadogWorkflowRole`.
2. Copy the External ID and configure it in the `shared.auto.tfvars.json`, also set the `enable_datadog_role` to true.
3. This should create a connection that will allow invoking the lambda from Datadog.
4. Once this is done, create a new workflow, then click `Edit JSON Spec`, copy the JSON. Then click the Invoke Lambda function action and edit the region value to the region where the Terraform has been deployed, and make sure you configure the Connection to the one configured previously.
